<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BlogTech | Foro</title>
    <link rel="stylesheet" href="/style/index">
    <link rel="stylesheet" href="/style/modal">
    <link rel="stylesheet" href="/style/foro">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="icon" href="../assets/image/pngegg.png" type="image/png">
</head>
<body>
    <header id="headerBody">
        <a class="h1" href="/home">BlogTech</a>
        <nav class="navbar">
            <a href="/git" class="ancoresNav">Git</a>
            <a href="/gitlab" class="ancoresNav">GitLab</a>
            <a href="/html" class="ancoresNav">HTML</a>
            <a href="/js" class="ancoresNav">JS</a>
            <a href="/css" class="ancoresNav">CSS</a>
            <a href="/foro" class="ancoresNav">Foro</a>
            <a id="aLogin" href="/login" class="ancoresNav">Iniciar Sesion</a>
            <div id="user-letter">K</div>
        </nav>
        <button class="menu-toggle" aria-label="MenÃº">
            â˜°
        </button>
    </header>
    <div id="menUser">
        <div class="user">KevinGr</div>
        <div class="logout"><a href="/logout">Cerrar Sesion</a></div>
    </div>

    <!-- Contenido principal -->
    <main id="main-content">
        <div id="header-foro">
            <section id="foro-msg">
                <h2 class="title-section">Bienvenido al Foro</h2>
                <p class="p-text">
                    Este es un espacio para compartir ideas, resolver dudas y colaborar con otros desarrolladores. Â¡Participa en las discusiones y aprende junto a la comunidad!
                </p>
                <i class="bi bi-x-circle-fill"></i>
            </section>
        </div>
        <div id="main">
            <div id="navLat">
                <button id="btn-publicar" onclick="openModal()">Publicar </button>
                <div class="item">
                    <h3 class="title-item">Categorias</h3>
                    <ul id="categoriaContainer" class="Categorias">
                        <input type="hidden" name="categoria" id="categoria-Select">
                        <li class="cat">Todas</li>
                    </ul>
                </div>
                <div class="item">
                    <h3 class="title-item">Filtrar por</h3>
                    <ul class="ul-item Filtrar">
                        <li class="li-item selected">Recientes</li>
                        <li class="li-item">Me gusta</li>
                    </ul>
                </div>
                <div class="item">
                    <h3 class="title-item">AÃ±adir</h3>
                    <ul class="ul-item Ordenar">
                        <li class="li-item new_cat">Categoria</li>
                        <li id="new-tema" class="li-item">Tema</li>
                    </ul>
                </div>
                <div class="item">
                    <h3 class="title-item">Temas</h3>
                    <ul id="listaTemas" class="ul-item Temas">
                        <li class="li-item li-tema" data-id="Novedades">Novedades ðŸŽ‰ðŸŽŠ</li>
                    </ul>
                </div>

            </div>

            <div id="contenido">
                <!-- Contenido de publicaciones -->
            </div>
            <section id="tema-section" class="tema">
                <h2 class="title-tema">Novedades ðŸŽ‰ ðŸŽŠ <i id="closeBtnTema" class="bi bi-x-circle-fill"></i></h2>
                <div class="tema-text">
                    <h3>BlogTech v1.0.0</h3>
                    <p>Novadades de la primera versiÃ³n</p>
                    <ul>
                        <li>Primeras publicaciones:
                            <p>Ahora Blogtech trae consigo un foro en el cual puedes crear tus primeras publicaciones</p>
                        </li>
                        <li>Temas:
                            <p>En foro tambien tienes la secciÃ³n de temas en el cual podes crear tus propios temas y tambien leer temas puntuales como este informe de novedades</p>
                        </li>
                        <li>Cuentas personales:
                            <p>Podras crear tus propias cuentas personales para poder interactuar con el foro, pero tambien esta previsto que estas cuentas funcionen como un roadmap para los temas que estudies o leas en blogtech, en el cual se guarte tu progreso.</p>
                        </li>
                    </ul>
                </div>
                <div class="tema-comentarios">
                    <h3>Comentarios</h3>
                    <form id="formulario-comentario" method="post">
                        <div class="text-input">
                            <textarea class="comentario" name="contenido" id="contenidoComentario" cols="30" rows="10" placeholder="Escribe tu Comentario..." required></textarea>
                        </div>
                    </form>
                    <article class="comentario">

                    </article>
                </div>
            </section>
        </div>
    </main>
    <dialog id="modalPost" closedBy="any">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="h2-title">Crear Publicacion</h2>
                <select name="categoria" id="categoria">
                    <option value="" disabled selected required>Selecciona una categoria</option>
                </select>
            </div>
            <div class="tools">
                <div class="item-tool">Herramientas <i class="bi bi-caret-down-fill"></i>
                    <div class="tool-group">
                        <i class="bi bi-fonts item-tool-icon"></i>
                        <i class="bi bi-image item-tool-icon"></i>
                        <i class="bi bi-link item-tool-icon"></i>
                    </div>
                </div>

            </div>
            <form id="formulario-post" method="post">
                <div class="text-input">
                        <textarea name="contenido" id="contenidoNew" cols="30" rows="10" placeholder="Escribe tu mensaje..." required></textarea>
                </div>
                <div class="btn-modal">
                    <input type="submit" value="Publicar" class="btn-add">

            </form>
            <form method="dialog">
                <button class="cerrar-modal" type="submit">Cancelar</button>
            </form>
        </div>

        </div>
    </dialog>
    <dialog id="modalCategoria" class="modalCategoria" closedBy="any">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="h2-title">AÃ±adir nueva categoria</h2>
            </div>
            <form id="formulario-categoria" method="post">
                <div class="text-input">
                    <label for="contenidoCategoria">Nombre de la categoria:</label>
                    <input type="text" name="nombre" id="contenidoCategoria" placeholder="Categoria" required>
                </div>
                <div class="btn-modal">
                    <input type="submit" value="Agregar Categoria" class="btn-add">
                </div>
            </form>
    </dialog>

    <dialog id="select-img-modal" closedBy="any" open="">
        <h2>Insertar imagen</h2>
        <div class="inputsImagens">
            <select name="img" id="img-post">
                <option value="" selected disabled>Elige el tipo de imagen</option>
                <option value="img">Imagen local</option>
                <option value="url">Imagen de la web (URL)</option>
            </select>
            <label for="widthImage">Ancho: </label>
            <input type="number" min="100" max="950" name="widthImage" id="widthImage" >
    
            <label for="heightImage">Alto: </label>
            <input type="number" min="100" max="500" name="heightImage" id="heightImage" >
            <button id="btnInsertarImage">Inserar</button>
        </div>
        
        <div class="showImage">
            <img id="previewImage" src="" alt="">
        </div>
        <div class="inser-img">
            <input type="file" name="imagen" id="">
            <input type="url" name="imagen" id="urlImage">
        </div>
        <script>
            const imagen = document.querySelector('#previewImage');
            const url = document.querySelector('#urlImage');
            const width = document.querySelector('#widthImage');
            const height = document.querySelector('#heightImage');

            width.addEventListener('input', () => {
                if(width.value !=0){
                    if(width.value > 950){
                        width.value = 950
                    }
                    imagen.style.width = `${width.value}px`;
                    height.value = 0;
                    imagen.style.height = 'auto';
                }else{
                    imagen.style.width = 'auto';
                }
            })
            height.addEventListener('input', () => {
                if(height.value !=0){
                    if(height.value > 500){
                        height.value = 500
                    }
                    imagen.style.height = `${height.value}px`;
                    width.value = 0;
                    imagen.style.width = 'auto';
                }else{
                    imagen.style.height = 'auto';
                }
            });
            url.addEventListener('input', () => {
                imagen.src=url.value;
            })

            document.addEventListener('DOMContentLoaded', () => {
    const fileInput = document.querySelector('input[type="file"][name="imagen"]');
    const previewImage = document.getElementById('previewImage');

    fileInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImage.src = e.target.result;
                };
                reader.readAsDataURL(file);
            } else {
                previewImage.src = '';
            }
        });
    });
        </script>
    </dialog>



    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="../script/foro.js"></script>
    <script type="module">
        import {getCategorias, getPosts } from '/script/get';
        const categorias = await getCategorias();
        const input = document.querySelector('#categoria-Select');

        const posts = await getPosts(localStorage.getItem('categoria')||"Todas");
        const todasCAt = document.querySelector('.cat');
        if(todasCAt.textContent == localStorage.getItem('categoria')){ todasCAt.classList.add('selected')}
        todasCAt.addEventListener('click', () => {
            localStorage.setItem('categoria', "Todas");
            location.reload();
        })
        const categoriasCat = document.querySelectorAll('.cat');
        categoriasCat.forEach((categoria) => {
            categoria.addEventListener('click', () => {
                if(categoria.textContent == localStorage.getItem('categoria')){
                    categoria.classList.add('selected');
                }
            })
        })

        const categoriaContainer = document.querySelector('#categoriaContainer');
        categorias.forEach((categoria) => {
            const li = document.createElement('li');
            input.value = "Todas";
            const option = document.createElement('option');
            option.value = categoria.nombre;
            option.textContent = categoria.nombre;
            document.querySelector('#categoria').appendChild(option);
            li.classList.add('cat');
            li.textContent = categoria.nombre;
            if(li.textContent == localStorage.getItem('categoria')) li.classList.add('selected');
            categoriaContainer.appendChild(li);
            li.addEventListener('click', () => {
                localStorage.setItem('categoria', li.textContent);
                location.reload();
            })
        })

        const postContainer = document.querySelector('#contenido');
        posts.forEach((post) => {
            const article = document.createElement('article');
            article.classList.add('articulo');
            article.setAttribute('id', post.id);
            article.setAttribute('datetime', post.fecha);

            article.innerHTML = `
                <header>
                    <h3 class="title-articulo">${post.usuario}</h3>
                    <p class="p-text">Fecha: ${post.fecha} ${post.hora}</p>
                </header>
                <div class="p-text" p-content>${post.contenido}</div>
                <div class="actions">
                    <div class="action">
                        <i class="bi bi-heart-fill"></i>
                        <p class="likes">${post.likes}</p>
                    </div>
                    <div class="action">
                        <a href="/post/${post.id}"><i class="bi bi-chat-fill"></i></a>
                        <p class="comments">${post.comentarios}</p>
                    </div>
                </div>
            `;
            postContainer.appendChild(article);
            const like = article.querySelector('.bi-heart-fill')
            likes(post.id);
        })

        const publicaciones = document.querySelectorAll('article')

        publicaciones.forEach((publicacion) => {

            const like = publicacion.querySelector('.bi-heart-fill');
            if(like != null){
                like.addEventListener('click', () => {
                if(localStorage.getItem('username') == null){
                    swal.fire({
                        icon: 'error',
                        title: 'Oops...',
                        text: 'Debes iniciar sesion para poder darle like',
                        showConfirmButton: false,
                        timer: 2000
                    })
                    return;
                }
                if(like.classList.contains('liked')){
                    fetch(`https://app-07f9025b-6a13-4685-a1e7-d30222c7d740.cleverapps.io/foro/dislike`,{
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            usuario: localStorage.getItem('username'),
                            post: publicacion.id
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        const Toast = Swal.mixin({
                            toast: true,
                            position: "top-end",
                            showConfirmButton: false,
                            timer: 1500,
                            timerProgressBar: true,
                            didOpen: (toast) => {
                                toast.onmouseenter = Swal.stopTimer;
                                toast.onmouseleave = Swal.resumeTimer;
                            }
                            });
                            Toast.fire({
                                icon: "success",
                                title: "Has quitado el me gusta a la publicacion"
                            });
                            setTimeout(() => {
                                window.location.reload();
                            },1500)
                    })
                    .catch(error => console.error('Error:', error));
                }else{
                    like.style.color = "#4b6577";
                fetch(`https://app-07f9025b-6a13-4685-a1e7-d30222c7d740.cleverapps.io/foro/likes`,{
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        usuario: localStorage.getItem('username'),
                        post: publicacion.id
                    })
                })
                .then(response => response.json())
                .then(data => {
                    const Toast = Swal.mixin({
                        toast: true,
                        position: "top-end",
                        showConfirmButton: false,
                        timer: 1500,
                        timerProgressBar: true,
                        didOpen: (toast) => {
                            toast.onmouseenter = Swal.stopTimer;
                            toast.onmouseleave = Swal.resumeTimer;
                        }
                        });
                        Toast.fire({
                            icon: "success",
                            title: "Le has dado me gusta a la publicacion"
                        });
                        setTimeout(() => {
                            window.location.reload();
                        },1500)
                })
                .catch(error => console.error('Error:', error));
                }
            });
            }
        });

        function publicar(event){
            event.preventDefault();
            const contenido = document.querySelector('#contenidoNew').value;
            function getDate(){
                const date = new Date();
                let fecha = date.toLocaleDateString('es-ES', {
                    day: 'numeric',
                    month: 'numeric',
                    year: 'numeric'
                    })
                fecha = fecha.replace(/-/g, "/");
                const time = date.toLocaleTimeString([], {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: true
                });
            
                return{ fecha, time };
            }

            fetch(`https://app-07f9025b-6a13-4685-a1e7-d30222c7d740.cleverapps.io/foro/newPublicacion`,{
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    fecha: getDate().fecha,
                    hora: getDate().time.replace(/[.Â ]/g,''),
                    usuario: localStorage.getItem('username'),
                    contenido: contenido,
                    categoria: document.querySelector('#categoria').value
                })
            })
            .then(response => response.json())
            .then(data => {
                const Toast = Swal.mixin({
                    toast: true,
                    position: "top-end",
                    showConfirmButton: false,
                    timer: 1000,
                    timerProgressBar: true,
                    didOpen: (toast) => {
                        toast.onmouseenter = Swal.stopTimer;
                        toast.onmouseleave = Swal.resumeTimer;
                    }
                    });
                    Toast.fire({
                        icon: "success",
                        title: "Has publicado tu post"
                    });
                    setTimeout(() => {
                        window.location.reload();
                    },1000)
            })
            .catch(error => console.error('Error:', error));
        }

        document.querySelector('#formulario-post').addEventListener('submit', publicar)
        function openModal(){
            document.querySelector('#modalPost').showModal();
        }
        function openModalCategoria(){
            document.querySelector('#modalCategoria').showModal();
        }
        document.querySelector('li.new_cat')
        .addEventListener('click', openModalCategoria)

        function agregarCategoria(event){
            event.preventDefault();
            const categoria = document.querySelector('#contenidoCategoria').value;
            const exist = categorias.find(cat => cat.nombre.toLowerCase() == categoria.toLowerCase());
            if(exist){
                const Toast = Swal.mixin({
                    toast: true,
                    position: "center",
                    showConfirmButton: false,
                    timer: 1000,
                    timerProgressBar: true,
                    didOpen: (toast) => {
                        toast.onmouseenter = Swal.stopTimer;
                        toast.onmouseleave = Swal.resumeTimer;
                    }
                    });
                    Toast.fire({
                        icon: "error",
                        title: "La categoria ya existe"
                    });
                return
            }
            fetch(`https://app-07f9025b-6a13-4685-a1e7-d30222c7d740.cleverapps.io/foro/newCategoria`,{
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    nombre: categoria,
                    creado: localStorage.getItem('username')
                })
            })
            .then(response => response.json())
            .then(data => {
                document.querySelector('#modalCategoria').close();
                const Toast = Swal.mixin({
                    toast: true,
                    position: "center",
                    showConfirmButton: false,
                    timer: 2500,
                    timerProgressBar: true,
                    didOpen: (toast) => {
                        toast.onmouseenter = Swal.stopTimer;
                        toast.onmouseleave = Swal.resumeTimer;
                    }
                    });
                    Toast.fire({
                        icon: "success",
                        title: `Felicidades, Has agregado una nueva categoria ${categoria}`
                    });
                    setTimeout(() => {
                        window.location.reload();
                    },2500)
            })
            .catch(error => console.error('Error:', error));
        }

        document.querySelector('#formulario-categoria').addEventListener('submit', agregarCategoria)
        

        document.querySelector('#btn-publicar').addEventListener('click', openModal)
    </script>
    <script>
        const headerArticle = document.querySelector('#header-foro');
        const closeHeader = document.querySelector('.bi-x-circle-fill');
        closeHeader.addEventListener('click', () => {
            headerArticle.classList.add('close')

            setTimeout(()=>{
                headerArticle.style.display = 'none';
            },800)
            document.querySelector('#contenido').style.height = "90vh";
            document.querySelector('#navLat').style.height = "90vh";
        });

        async function likes(id){

            if(localStorage.getItem('username') == null){
                swal.fire({
                    icon: 'error',
                    title: 'Oops...',
                    text: 'Debes iniciar sesion para poder darle like',
                    showConfirmButton: false,
                    timer: 2000
                })
                return;
            }
            
            fetch(`https://app-07f9025b-6a13-4685-a1e7-d30222c7d740.cleverapps.io/foro/userLikes`,{
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            usuario: localStorage.getItem('username'),
        })
    })
        .then(response => response.json())
        .then(data => {
            const likesUSer = data;
            likesUSer.forEach((like) => {
                if(like.post == id){
                    const post = document.getElementById(id);
                    const likeIcon = post.querySelector('.bi-heart-fill');
                    likeIcon.style.color = "#4b6577";
                    likeIcon.classList.add('liked');
                }
            });
        })
        .catch(error => console.error('Error:', error));
        }
    </script>
    <script src="/script/index"></script>
    <script>
        fetch('https://app-07f9025b-6a13-4685-a1e7-d30222c7d740.cleverapps.io/foro/temas')
        .then(response => response.json())
        .then(data => {
            const temas = data;
            temas.forEach(tema => {

                temainnerHTML=`
                <li class="li-item" data-id="${tema.id}">${tema.tema}</li>
                `
                console.log(temainnerHTML);
                document.querySelector('#listaTemas').insertAdjacentHTML('beforeend', temainnerHTML);
            });
        })
        .catch(error => console.error('Error:', error));
    </script>
</body>
</html>